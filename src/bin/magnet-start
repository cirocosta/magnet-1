#!/usr/bin/env node --harmony-async-await

import parseArgs from 'minimist'
import path from 'path'
import { existsSync } from 'fs';
import Magnet from '../magnet';
import _ from 'lodash';
import {ExpressEngine} from '../magnet';
import chokidar from 'chokidar';

process.env.NODE_ENV = process.env.NODE_ENV || 'production';
const rootDir = process.cwd();
const { NODE_ENV } = process.env;

const argv = parseArgs(process.argv.slice(2), {
  alias: {
    h: 'help',
    p: 'port',
    e: 'env'
  },
  boolean: ['h'],
  default: {
    p: 3000
  }
});

if (argv.help) {
  console.log(`
    Description
      Starts the application in production mode.
    Usage
      $ magnet start <dir> -p <port> -e <environment file path>
    If no directory is provided, the current directory will be assumed.
    Options
      --port, -p      A port number on which to start the application
      --env, -e       Environemnt config file path
      --help, -h      Displays this message
  `)
  process.exit(0)
}

let magnetEnv = {};

if (argv.env) {
  if (existsSync(path.join(rootDir, argv.env))) {
    magnetEnv = require(path.join(rootDir, argv.env));
    if (magnetEnv.default) {
      magnetEnv = magnetEnv.default;
    }
  } else {
    console.log('Environment file doesn\'t exist.');
    process.exit(1);
  }
} else {
  magnetEnv = {
    magnet: {
      port: argv.port,
      host: 'localhost'
    }
  };
}

const engine = new ExpressEngine();
const magnetConfig = {
  appEnvironment: magnetEnv,
  appDirectory: rootDir,
  serverEngine: engine,
};

let magnet = new Magnet(magnetConfig);

// - External Start and Stop
if (existsSync(path.join(rootDir, 'start.js'))) {
  let startFn = require(path.join(rootDir, 'start.js'));

  if (startFn.default) {
    startFn = startFn.default;
  }

  magnet.setStartLifecycle(startFn);
}

if (existsSync(path.join(rootDir, 'stop.js'))) {
  let stopFn = require(path.join(rootDir, 'stop.js'));

  if (stopFn.default) {
    stopFn = stopFn.default;
  }

  magnet.setStopLifecycle(stopFn);
}

// Stop SIGNTERM
// process.on('SIGTERM', () => {
//   watcher.close();
//   magnet.stop();
// });

// // listen for INT signal e.g. Ctrl-C
// process.on('SIGINT', () => {
//   watcher.close();
//   magnet.stop();
// });



magnet.setupApplication()
      .then((instance) => {
        magnet.start(instance);
      });

const watcher = chokidar.watch(`${rootDir}/**/*`, {
  ignoreInitial: true
});

const refreshFiles = _.debounce(() => {
    const d = Date.now()

    const fileGen = new Promise((resolve, reject) => {
      if (magnet) {
        magnet.stop();
      }
      const newEngine = new ExpressEngine();
      const newMagnetConfig = {
        appEnvironment: magnetEnv,
        appDirectory: rootDir,
        serverEngine: newEngine,
      }
      magnet = new Magnet(newMagnetConfig);
      magnet.setupApplication()
            .then((instance) => {
              magnet.start(instance);
            });
      resolve();
    });

    fileGen.then(() => {
      console.log('Time to gen:' + (Date.now() - d) + 'ms')
    })

  }, 200);

watcher
  .on('change',refreshFiles);
